<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPS Reading Test - Result System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --main: #00b4db; --bg: #12192c; --correct: #2ecc71; --wrong: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; color: #333; }
        #exam-page, #result-page { display: none; background: #f4f7f6; min-height: 100vh; flex-direction: column; }
        .card { background: white; margin: 15px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .opt-btn { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 12px; display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; }
        .opt-num { width: 30px; height: 30px; border: 1px solid #ddd; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 15px; font-weight: bold; }
        .palette { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px; }
        .p-btn { background: white; border: 1px solid #ccc; padding: 10px; text-align: center; border-radius: 5px; }
        .p-btn.done { background: var(--main); color: white; border: none; }
        
        /* Result Styles */
        .res-item { padding: 15px; border-radius: 10px; margin-bottom: 10px; color: white; }
        .res-correct { background: var(--correct); }
        .res-wrong { background: var(--wrong); }
        .res-info { font-size: 0.9rem; margin-top: 5px; opacity: 0.9; }
    </style>
</head>
<body>

<div id="login" style="text-align:center; padding: 50px 20px;">
    <h1 style="color:white;">EPS-TOPIK 읽기</h1>
    <input type="text" id="student-name" placeholder="သင့်နာမည်ရိုက်ထည့်ပါ" style="width:80%; padding:15px; border-radius:10px; border:none; font-size:16px;">
    <br><br>
    <button onclick="start()" style="width:80%; padding:15px; background:var(--main); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">START EXAM</button>
</div>

<div id="exam-page">
    <div style="background:#1a233a; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
        <span id="user-display"></span>
        <span id="timer" style="background:#e74c3c; padding:5px 15px; border-radius:5px; font-weight:bold;">20:00</span>
    </div>
    <div style="flex:1; overflow-y:auto;">
        <div class="card">
            <h3 id="q-no" style="color:var(--main); margin-top:0;"></h3>
            <p id="q-text" style="font-size:18px; line-height:1.5;"></p>
            <img id="q-img" style="width:100%; border-radius:10px; display:none; margin-top:10px;">
        </div>
        <div id="options" style="padding:0 15px;"></div>
        <div class="palette" id="palette"></div>
    </div>
    <div style="background:#1a233a; padding:10px; display:flex; justify-content:space-around;">
        <button onclick="move(-1)" style="padding:12px 30px; border-radius:5px; border:none; background:#444; color:white;">PREV</button>
        <button onclick="move(1)" style="padding:12px 30px; border-radius:5px; border:none; background:#444; color:white;">NEXT</button>
        <button onclick="finish()" style="padding:12px 30px; border-radius:5px; border:none; background:#ff0055; color:white; font-weight:bold;">FINISH</button>
    </div>
</div>

<div id="result-page">
    <div style="background:var(--main); color:white; padding:30px; text-align:center;">
        <h2 style="margin:0;">Exam Result</h2>
        <div id="score-display" style="font-size:3rem; font-weight:bold; margin:10px 0;">0</div>
        <p id="status-text"></p>
    </div>
    <div id="result-list" style="padding:15px; flex:1; overflow-y:auto;"></div>
    <button onclick="location.reload()" style="padding:20px; background:#1a233a; color:white; border:none; font-weight:bold;">RESTART EXAM</button>
</div>

<script>
    let questions = [], answers = [], current = 0;
    const apiURL = "https://script.google.com/macros/s/AKfycbycLVJ64q_BiSIVvsugR4pFn0tk8tkaS-agzwICHSbMOK0dNtw5-ZgLe-H5lMaU9Gax8w/exec"; // <--- အရေးကြီးသည်

    async function start() {
        const name = document.getElementById('student-name').value;
        if(!name) return alert("နာမည်ထည့်ပေးပါဗျ");
        document.getElementById('user-display').innerText = "Candidate: " + name;
        document.getElementById('login').innerHTML = "<h2 style='color:white;'>Loading Questions...</h2>";
        
        try {
            const res = await fetch(apiURL);
            questions = await res.json();
            answers = new Array(questions.length).fill(null);
            document.getElementById('login').style.display = 'none';
            document.getElementById('exam-page').style.display = 'flex';
            showQ();
        } catch(e) { alert("Error: အင်တာနက်စစ်ပါ သို့မဟုတ် URL မှားနေပါတယ်"); }
    }

    function showQ() {
        const q = questions[current];
        document.getElementById('q-no').innerText = `Question ${current + 1}`;
        document.getElementById('q-text').innerText = q.text;
        const img = document.getElementById('q-img');
        if(q.img) { img.src = q.img; img.style.display = 'block'; } else { img.style.display = 'none'; }
        
        const optArea = document.getElementById('options');
        optArea.innerHTML = "";
        q.options.forEach((opt, i) => {
            const active = answers[current] === i;
            optArea.innerHTML += `<div class="opt-btn" onclick="hit(${i})" style="${active?'border:2px solid var(--main); background:#e1f5fe':''}">
                <div class="opt-num" style="${active?'background:var(--main); color:white':''}">${i+1}</div>${opt}</div>`;
        });
        drawPalette();
    }

    function hit(i) { answers[current] = i; showQ(); }
    function move(step) { 
        current += step;
        if(current < 0) current = 0;
        if(current >= questions.length) current = questions.length - 1;
        showQ();
    }
    function drawPalette() {
        const p = document.getElementById('palette');
        p.innerHTML = "";
        questions.forEach((_, i) => {
            p.innerHTML += `<div class="p-btn ${answers[i]!==null?'done':''}" onclick="current=${i};showQ()">${i+1}</div>`;
        });
    }

    function finish(let base64Image = ""; // ပုံကို သိမ်းထားရန် Variable

// ပုံရွေးလိုက်တဲ့အခါ base64 အဖြစ်ပြောင်းသိမ်းခြင်း
function previewFile() {
    const preview = document.getElementById('preview-img');
    const file = document.getElementById('file-input').files[0];
    const placeholder = document.getElementById('upload-placeholder');
    const reader = new FileReader();
    
    reader.onloadend = () => { 
        base64Image = reader.result; // ပုံဒေတာကို သိမ်းလိုက်ခြင်း
        preview.src = reader.result; 
        preview.style.display = "block"; 
        placeholder.style.display = "none"; 
    }
    if (file) reader.readAsDataURL(file);
}

async function finish() {
    if(!confirm("Finish Exam?")) return;
    
    let score = 0;
    questions.forEach((q, i) => { if(answers[i] === q.ans) score += 5; });

    const name = document.getElementById('user-name').value;
    const sector = document.getElementById('job-sector').value;

    // Google Sheet ထံ ဒေတာပို့ခြင်း
    try {
        await fetch(apiURL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ 
                name: name, 
                sector: sector,
                score: score, 
                image: base64Image, // ပုံဒေတာ
                details: "Reading Exam Result" 
            })
        });
        alert("Result and Photo saved successfully!");
        location.reload();
    } catch(e) { console.error(e); }
}
) {
        if(!confirm("စာမေးပွဲ အဆုံးသတ်မှာ သေချာပါသလား?")) return;
        
        let score = 0;
        const listArea = document.getElementById('result-list');
        listArea.innerHTML = "";

        questions.forEach((q, i) => {
            const isCorrect = answers[i] === q.ans;
            if(isCorrect) score += 5;

            const div = document.createElement('div');
            div.className = `res-item ${isCorrect ? 'res-correct' : 'res-wrong'}`;
            div.innerHTML = `
                <strong>မေးခွန်း (${i+1}) : ${isCorrect ? 'မှန်ကန်သည်' : 'မှားယွင်းသည်'}</strong>
                <div class="res-info">သင့်အဖြေ: ${answers[i] !== null ? q.options[answers[i]] : 'ဖြေဆိုထားခြင်းမရှိပါ'}</div>
                <div class="res-info">အဖြေမှန်: ${q.options[q.ans]}</div>
            `;
            listArea.appendChild(div);
        });

        document.getElementById('score-display').innerText = score;
        document.getElementById('status-text').innerText = score >= 80 ? "Pass (အောင်မြင်ပါသည်)" : "Fail (ထပ်မံကြိုးစားပါ)";
        document.getElementById('exam-page').style.display = 'none';
        document.getElementById('result-page').style.display = 'flex';
    }
</script>
</body>
</html>
