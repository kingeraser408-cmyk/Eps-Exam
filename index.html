<script>
    let currentIdx = 0;
    let timeLeft = 20 * 60; 
    let selectedAnswers = [];
    let userData = { photo: "" };
    let questions = []; // မေးခွန်းများကို အလွတ်ထားထားပါ

    // ၁။ Google Sheets မှ မေးခွန်းများ ဆွဲယူမည့် Function
    async function fetchQuestions() {
        // အောက်က Link နေရာမှာ လူကြီးမင်း Deploy လုပ်လို့ရလာတဲ့ Link ကို အစားထိုးပါ
        const sheetURL = "https://script.google.com/macros/s/AKfycbycLVJ64q_BiSIVvsugR4pFn0tk8tkaS-agzwICHSbMOK0dNtw5-ZgLe-H5lMaU9Gax8w/exec"; 
        
        try {
            const response = await fetch(sheetURL);
            questions = await response.json();
            selectedAnswers = new Array(questions.length).fill(null);
            console.log("Questions Loaded Successfully!");
        } catch (error) {
            console.error("Error fetching questions:", error);
            alert("မေးခွန်းများ ဆွဲယူ၍ မရပါ။ Link ကို ပြန်စစ်ပါ။");
        }
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('user-photo-preview').src = e.target.result;
                document.getElementById('user-photo-preview').style.display = 'block';
                document.getElementById('placeholder-text').style.display = 'none';
                userData.photo = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // ၂။ Start Exam နှိပ်လိုက်ရင် မေးခွန်းတွေကို အရင်ဆွဲမယ်
    async function startExam() {
        const nameInput = document.getElementById('user-name').value;
        if(!nameInput || !userData.photo) {
            alert("နာမည်နဲ့ ဓာတ်ပုံ အရင်ထည့်ပေးပါဗျာ။");
            return;
        }

        // မေးခွန်းများ စတင်ဆွဲယူခြင်း
        document.querySelector('.start-btn').innerText = "LOADING...";
        await fetchQuestions();

        if(questions.length === 0) return;

        document.getElementById('display-name').innerText = nameInput;
        document.getElementById('display-job').innerText = document.getElementById('user-job').value;
        document.getElementById('exam-user-img').src = userData.photo;

        document.getElementById('login-page').style.display = 'none';
        document.getElementById('exam-page').style.display = 'flex';
        
        loadQuestion();
        runTimer();
    }

    function runTimer() {
        const timerDisplay = document.getElementById('timer-display');
        const countdown = setInterval(() => {
            let mins = Math.floor(timeLeft / 60);
            let secs = timeLeft % 60;
            timerDisplay.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            if (timeLeft <= 0) {
                clearInterval(countdown);
                finishExam();
            }
            timeLeft--;
        }, 1000);
    }

    function loadQuestion() {
        const q = questions[currentIdx];
        document.getElementById('q-number').innerText = `[Question ${currentIdx + 1}]`;
        document.getElementById('q-text').innerText = q.text;
        
        const imgTag = document.getElementById('q-img');
        if(q.img) { imgTag.src = q.img; imgTag.style.display = 'block'; }
        else { imgTag.style.display = 'none'; }

        const audioSec = document.getElementById('audio-container');
        const audioTag = document.getElementById('q-audio');
        if(q.audio) { 
            audioTag.src = q.audio; 
            audioSec.style.display = 'block'; 
        } else { 
            audioSec.style.display = 'none';
            audioTag.pause(); 
        }

        const optDiv = document.getElementById('options');
        optDiv.innerHTML = "";
        q.options.forEach((opt, i) => {
            const isSelected = selectedAnswers[currentIdx] === i;
            optDiv.innerHTML += `
                <div class="opt-btn" onclick="selectOpt(${i})" style="${isSelected ? 'background:#e1f5fe; border:2px solid #00b4db;' : ''}">
                    <div class="opt-num" style="${isSelected ? 'background:#00b4db; color:white;' : ''}">${i+1}</div>
                    ${opt}
                </div>`;
        });
    }

    function selectOpt(idx) { selectedAnswers[currentIdx] = idx; loadQuestion(); }
    function nextQ() { if(currentIdx < questions.length - 1) { currentIdx++; loadQuestion(); } }
    function prevQ() { if(currentIdx > 0) { currentIdx--; loadQuestion(); } }
    function finishExam() { alert("ဖြေဆိုမှု ပြီးဆုံးပါပြီ။"); location.reload(); }
</script>
