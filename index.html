<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UBT & Color Blind Test System</title>
    <style>
        :root { --primary: #00b4db; --dark: #12192c; --white: #ffffff; --danger: #ff0055; --success: #2ecc71; }
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; color: #333; overflow-x: hidden; }
        
        .page { display: none; min-height: 100vh; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .active-page { display: flex; }

        .card { width: 100%; max-width: 400px; background: #161b22; border-radius: 15px; border: 1px solid #30363d; color: white; padding-bottom: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(90deg, #00d2ff, #3a7bd5); padding: 15px; text-align: center; font-weight: bold; }
        input, select { width: 85%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: white; }
        .btn { width: 85%; padding: 15px; border: none; background: linear-gradient(90deg, #00f260, #0575e6); color: white; font-weight: bold; border-radius: 8px; cursor: pointer; }

        #exam-page { background: #f0f2f5; justify-content: flex-start; }
        .top-bar { width: 100%; background: #1a233a; color: white; padding: 12px; display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .q-card { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 10px; margin-top: 20px; border-top: 5px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .audio-btn { background: #ffc107; border: none; padding: 12px 20px; border-radius: 25px; margin: 10px 0; cursor: pointer; font-weight: bold; width: 100%; }
        .audio-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .option { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin: 10px 0; display: flex; align-items: center; cursor: pointer; transition: 0.2s; width: 100%; max-width: 600px; box-sizing: border-box; }
        .option.active { border: 2px solid var(--primary); background: #e1f5fe; }
        .opt-num { width: 30px; height: 30px; border: 1px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 15px; flex-shrink: 0; }

        /* Floating Navigation Menu (Updated to Bottom Right) */
        .palette-toggle { 
            position: fixed; 
            right: 20px; 
            bottom: 25px; /* ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÅ·Äº·Ä±·Äô·Äæ·Ä¨ ·Äë·Ä¨·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ */
            background: #1a233a; 
            color: white; 
            padding: 15px 20px; 
            cursor: pointer; 
            border-radius: 50px; /* ·Äù·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äù·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äú·Ä±·Ä∏ ·Äú·ÄØ·Äï·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Äö·Ä∫ */
            z-index: 1001; 
            font-size: 14px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 2px solid var(--primary);
            font-weight: bold;
        }
        
        .side-menu { position: fixed; right: -300px; top: 0; width: 280px; height: 100vh; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: 0.3s; z-index: 1002; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .side-menu.open { right: 0; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px; }
        .num-btn { padding: 10px 0; border: 1px solid #ddd; text-align: center; border-radius: 5px; cursor: pointer; font-size: 13px; background: #f8f9fa; }
        .num-btn.done { background: var(--success); color: white; border-color: #27ae60; }
        .num-btn.current { background: var(--primary); color: white; font-weight: bold; border: 2px solid #008ba3; }

        .cb-img { width: 250px; height: 250px; border-radius: 50%; border: 5px solid white; margin: 20px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="login-page" class="page active-page">
    <div class="card">
        <div class="header">UBT EXAM LOGIN</div>
        <center>
            <input type="text" id="user-name" placeholder="·Ä°·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´">
            <select id="user-job">
                <option>Manufacturing (Ï†úÏ°∞ÏóÖ)</option>
                <option>Agriculture (ÎÜçÏóÖ)</option>
                <option>Construction (Í±¥ÏÑ§ÏóÖ)</option>
                <option>Fishery (Ïñ¥ÏóÖ)</option>
            </select>
            <button class="btn" onclick="startExam()">START EXAM</button>
            <p style="font-size: 12px; color: #58a6ff; cursor: pointer; margin-top: 15px;" onclick="viewResults()">VIEW OLD RESULTS</p>
        </center>
    </div>
</div>

<div id="exam-page" class="page">
    <div class="top-bar">
        <div id="display-name">Name</div>
        <div id="timer" style="background:var(--danger); padding:3px 12px; border-radius:5px; font-weight:bold;">20:00</div>
    </div>
    <div class="q-card">
        <div id="q-no" style="color:var(--primary); font-weight:bold;">Question 1</div>
        <div id="q-text" style="font-size: 18px; margin: 10px 0;"></div>
        <div id="q-audio-box"></div>
        <img id="q-img" src="" style="width:100%; display:none; border-radius:8px;">
    </div>
    <div id="options-container" style="width:100%; max-width:600px;"></div>
    
    <div style="display:flex; gap:10px; margin-top:20px; width:100%; max-width:600px; margin-bottom: 80px;">
        <button class="btn" style="background:#2c3e50;" onclick="prevQ()">PREV</button>
        <button class="btn" style="background:#2c3e50;" onclick="nextQ()">NEXT</button>
    </div>

    <div class="palette-toggle" onclick="toggleMenu()">QUESTIONS ‚ò∞</div>
    
    <div id="side-menu" class="side-menu">
        <h3 style="margin-top:0; font-size:18px; color:#1a233a; border-bottom: 2px solid #eee; padding-bottom: 10px;">Reading (ÏùΩÍ∏∞)</h3>
        <div id="reading-grid" class="grid"></div>
        <h3 style="font-size:18px; color:#1a233a; border-bottom: 2px solid #eee; padding-bottom: 10px;">Listening (Îì£Í∏∞)</h3>
        <div id="listening-grid" class="grid"></div>
        <button class="btn" style="width:100%; background:var(--danger);" onclick="toggleMenu()">CLOSE</button>
    </div>
</div>

<div id="cb-page" class="page">
    <div class="card" style="text-align: center;">
        <div class="header">COLOR BLIND TEST</div>
        <div id="cb-q-no" style="margin-top:10px;">Plate 1 of 5</div>
        <img id="cb-display-img" class="cb-img" src="cb1.jpg">
        <input type="number" id="cb-input" placeholder="·Äï·ÄØ·Ä∂·Äë·Ä≤·ÄÄ·ÄÇ·Äè·Äî·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´">
        <button class="btn" onclick="nextCB()">NEXT PLATE</button>
    </div>
</div>

<script>
    const apiURL = "https://script.google.com/macros/s/AKfycbyWbXxbzDWVYJVUr0jzVr7JSEIseiTs1VSd5RCo9dDvmoxUZklKqfX8vSeAgNvHBirS9A/exec";
    let questions = [];
    let current = 0;
    let answers = [];
    let audioCounts = {};
    let timeLeft = 20 * 60;
    let cbCurrent = 1;

    async function startExam() {
        const name = document.getElementById('user-name').value;
        if(!name) return alert("·Äî·Ä¨·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´");
        document.getElementById('login-page').classList.remove('active-page');
        document.getElementById('exam-page').classList.add('active-page');
        document.getElementById('display-name').innerText = name;
        try {
            const res = await fetch(apiURL);
            questions = await res.json();
            answers = new Array(questions.length).fill(null);
            renderQ();
            startTimer();
        } catch(e) { alert("Data Error!"); }
    }

    function renderQ() {
        const q = questions[current];
        document.getElementById('q-no').innerText = `Question ${current + 1}`;
        document.getElementById('q-text').innerText = q.text || "";
        const aBox = document.getElementById('q-audio-box');
        if (q.audio) {
            let count = audioCounts[current] || 0;
            aBox.innerHTML = `<button class="audio-btn" onclick="playAudio('${q.audio}', ${current})" ${count >= 2 ? 'disabled' : ''}>
                üîä ${count >= 2 ? 'LIMIT REACHED' : 'LISTEN (' + count + '/2)'}
            </button>`;
        } else { aBox.innerHTML = ""; }
        const img = document.getElementById('q-img');
        if(q.img) { img.src = q.img; img.style.display = "block"; } else { img.style.display = "none"; }
        const optDiv = document.getElementById('options-container');
        optDiv.innerHTML = "";
        q.options.forEach((opt, i) => {
            let content = opt.toString().match(/\.(jpg|jpeg|png)$/i) ? `<img src="${opt}" style="height:70px; border-radius:5px;">` : 
                          opt.toString().match(/\.mp3$/i) ? `<button class="audio-btn" style="margin:0; width:auto;" onclick="event.stopPropagation(); new Audio('${opt}').play()">üîä Audio</button>` : 
                          `<span>${opt}</span>`;
            optDiv.innerHTML += `<div class="option ${answers[current]===i?'active':''}" onclick="setAns(${i})"><div class="opt-num">${i+1}</div><div>${content}</div></div>`;
        });
        updatePalette();
    }

    function playAudio(url, id) {
        if (!audioCounts[id]) audioCounts[id] = 0;
        if (audioCounts[id] < 2) { new Audio(url).play(); audioCounts[id]++; renderQ(); }
    }
    function setAns(i) { answers[current] = i; renderQ(); }
    function nextQ() { if(current < questions.length-1) { current++; renderQ(); } }
    function prevQ() { if(current > 0) { current--; renderQ(); } }
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }

    function updatePalette() {
        const rGrid = document.getElementById('reading-grid');
        const lGrid = document.getElementById('listening-grid');
        rGrid.innerHTML = ""; lGrid.innerHTML = "";
        questions.forEach((_, i) => {
            const btn = document.createElement('div');
            btn.className = `num-btn ${answers[i] !== null ? 'done' : ''} ${i === current ? 'current' : ''}`;
            btn.innerText = i + 1;
            btn.onclick = () => { current = i; renderQ(); if(window.innerWidth < 768) toggleMenu(); };
            if (i < 20) rGrid.appendChild(btn); else lGrid.appendChild(btn);
        });
    }

    function startTimer() {
        setInterval(() => {
            if(timeLeft <= 0) location.reload();
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
        }, 1000);
    }

    function goToColorBlind() {
        document.getElementById('exam-page').classList.remove('active-page');
        document.getElementById('cb-page').classList.add('active-page');
    }

    function nextCB() {
        if(cbCurrent < 5) {
            cbCurrent++;
            document.getElementById('cb-q-no').innerText = `Plate ${cbCurrent} of 5`;
            document.getElementById('cb-display-img').src = `cb${cbCurrent}.jpg`;
            document.getElementById('cb-input').value = "";
        } else { submitResults(); }
    }

    async function submitResults() {
        let score = 0;
        questions.forEach((q, i) => { if(answers[i] === q.ans) score += 5; });
        const data = { name: document.getElementById('user-name').value, sector: document.getElementById('user-job').value, score: score };
        await fetch(apiURL, { method: "POST", body: JSON.stringify(data) });
        alert("·ÄÖ·Ä¨·Äô·Ä±·Ä∏·Äï·ÄΩ·Ä≤·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã");
        location.reload();
    }

    async function viewResults() {
        const name = prompt("·Äî·Ä¨·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´:");
        if(name) {
            const res = await fetch(`${apiURL}?viewResult=true&name=${name}`);
            const data = await res.json();
            if(data.length > 0) alert(`·Äõ·Äô·Äæ·Äê·Ä∫: ${data[data.length-1][3]}`);
            else alert("·Äô·Äõ·Äæ·Ä≠·Äï·Ä´·Åã");
        }
    }
</script>
</body>
</html>
