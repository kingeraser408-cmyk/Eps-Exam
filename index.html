<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UBT & Certificate System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #00b4db; --dark: #12192c; --white: #ffffff; --danger: #ff0055; --success: #2ecc71; --gold: #d4af37; }
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; color: #333; overflow-x: hidden; }
        
        .page { display: none; min-height: 100vh; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .active-page { display: flex; }

        .card { width: 100%; max-width: 450px; background: #161b22; border-radius: 15px; border: 1px solid #30363d; color: white; padding-bottom: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(90deg, #00d2ff, #3a7bd5); padding: 15px; text-align: center; font-weight: bold; }
        input, select { width: 85%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: white; }
        .btn { width: 85%; padding: 15px; border: none; background: linear-gradient(90deg, #00f260, #0575e6); color: white; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        /* Exam UI */
        #exam-page { background: #f0f2f5; justify-content: flex-start; }
        .top-bar { width: 100%; background: #1a233a; color: white; padding: 12px; display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .q-card { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 10px; margin-top: 20px; border-top: 5px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .audio-btn { background: #ffc107; border: none; padding: 12px 20px; border-radius: 25px; margin: 10px 0; cursor: pointer; font-weight: bold; width: 100%; }
        .audio-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .option { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin: 10px 0; display: flex; align-items: center; cursor: pointer; transition: 0.2s; width: 100%; max-width: 600px; box-sizing: border-box; }
        .option.active { border: 2px solid var(--primary); background: #e1f5fe; }
        .opt-num { width: 30px; height: 30px; border: 1px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 15px; flex-shrink: 0; color: #333; }

        /* Result & Review Section */
        .result-container { background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 500px; text-align: center; color: #333; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .status-badge { font-size: 48px; font-weight: bold; margin-bottom: 10px; }
        .review-scroll { max-height: 250px; overflow-y: auto; background: #f8f9fa; border-radius: 10px; padding: 10px; text-align: left; margin: 15px 0; border: 1px solid #eee; }
        .review-line { padding: 8px; border-bottom: 1px solid #e0e0e0; font-size: 14px; }
        .correct-ans { color: var(--success); font-weight: bold; }
        .wrong-ans { color: var(--danger); font-weight: bold; }

        /* Floating Palette */
        .palette-toggle { position: fixed; right: 20px; bottom: 25px; background: #1a233a; color: white; padding: 15px 20px; cursor: pointer; border-radius: 50px; z-index: 1001; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid var(--primary); font-weight: bold; }
        .side-menu { position: fixed; right: -300px; top: 0; width: 280px; height: 100vh; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: 0.3s; z-index: 1002; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .side-menu.open { right: 0; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px; }
        .num-btn { padding: 10px 0; border: 1px solid #ddd; text-align: center; border-radius: 5px; cursor: pointer; font-size: 13px; background: #f8f9fa; color: #333; }
        .num-btn.done { background: var(--success); color: white; }
        .num-btn.current { background: var(--primary); color: white; border: 2px solid #008ba3; }

        /* Color Blind UI */
        #cb-page { background: var(--dark); }
        .cb-img { width: 250px; height: 250px; border-radius: 50%; border: 5px solid white; margin: 20px 0; display: block; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>

<div id="login-page" class="page active-page">
    <div class="card">
        <div class="header">UBT & Colour Blind Test EXAM LOGIN</div>
        <center>
            <input type="text" id="user-name" placeholder="·Ä°·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´">
            <select id="user-job">
                <option>Manufacturing (Ï†úÏ°∞ÏóÖ)</option>
                <option>Agriculture (ÎÜçÏóÖ)</option>
                <option>Construction (Í±¥ÏÑ§ÏóÖ)</option>
                <option>Fishery (Ïñ¥ÏóÖ)</option>
            </select>
            <button class="btn" onclick="startExam()">START EXAM</button>
            <p style="font-size: 12px; color: #58a6ff; cursor: pointer; margin-top: 15px;" onclick="viewResults()">VIEW OLD RESULTS</p>
        </center>
    </div>
</div>

<div id="exam-page" class="page">
    <div class="top-bar">
        <div id="display-name">Name</div>
        <div id="timer" style="background:var(--danger); padding:3px 12px; border-radius:5px; font-weight:bold;">50:00</div>
    </div>
    <div class="q-card">
        <div id="q-no" style="color:var(--primary); font-weight:bold;">Question 1</div>
        <div id="q-text" style="font-size: 18px; margin: 10px 0; color:#333;"></div>
        <div id="q-audio-box"></div>
        <img id="q-img" style="width:100%; display:none; border-radius:8px; margin-top:10px;">
    </div>
    <div id="options-container" style="width:100%; max-width:600px;"></div>
    
    <div style="display:flex; gap:10px; margin-top:20px; width:100%; max-width:600px; margin-bottom: 80px;">
        <button class="btn" style="background:#2c3e50;" onclick="prevQ()">PREV</button>
        <button class="btn" style="background:#2c3e50;" onclick="nextQ()">NEXT</button>
    </div>

    <div class="palette-toggle" onclick="toggleMenu()">QUESTIONS ‚ò∞</div>
    <div id="side-menu" class="side-menu">
        <h3 style="margin-top:0; font-size:18px;">Reading (ÏùΩÍ∏∞)</h3>
        <div id="reading-grid" class="grid"></div>
        <h3 style="font-size:18px;">Listening (Îì£Í∏∞)</h3>
        <div id="listening-grid" class="grid"></div>
        <button class="btn" style="width:100%; background:var(--danger);" onclick="finishPartOne()">FINISH EXAM</button>
        <button class="btn" style="width:100%; background:#2c3e50; margin-top:10px;" onclick="toggleMenu()">CLOSE</button>
    </div>
</div>

<div id="cb-page" class="page">
    <div class="card" style="text-align: center;">
        <div class="header">COLOR BLIND TEST</div>
        <div id="cb-q-no" style="margin-top:10px; color:white;">Plate 1 of 5</div>
        <img id="cb-display-img" class="cb-img" src="cb1.jpg">
        <input type="number" id="cb-input" placeholder="·ÄÇ·Äè·Äî·Ä∫·Ä∏·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´">
        <button class="btn" onclick="nextCB()">NEXT PLATE</button>
    </div>
</div>

<div id="result-page" class="page">
    <div class="result-container">
        <div id="status-badge" class="status-badge"></div>
        <h2 id="final-score" style="margin: 0;">Score: 0</h2>
        <p id="final-stats"></p>
        
        <div class="review-scroll" id="review-list"></div>

        <button id="download-btn" class="btn" style="background:var(--gold); display:none; margin-bottom: 10px;" onclick="generateCertificate()">DOWNLOAD CERTIFICATE (PDF)</button>
        <button class="btn" style="background:#2c3e50;" onclick="location.reload()">TRY AGAIN</button>
    </div>
</div>

<script>
    const apiURL = "https://script.google.com/macros/s/AKfycbyWbXxbzDWVYJVUr0jzVr7JSEIseiTs1VSd5RCo9dDvmoxUZklKqfX8vSeAgNvHBirS9A/exec";
    let questions = [], current = 0, answers = [], audioLogs = {}, timeLeft = 50 * 60, cbCurrent = 1;

    async function startExam() {
        const name = document.getElementById('user-name').value;
        if(!name) return alert("·Äî·Ä¨·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´");
        document.getElementById('login-page').classList.remove('active-page');
        document.getElementById('exam-page').classList.add('active-page');
        document.getElementById('display-name').innerText = name;
        try {
            const res = await fetch(apiURL);
            questions = await res.json();
            answers = new Array(questions.length).fill(null);
            renderQ();
            startTimer();
        } catch(e) { alert("Data Fetch Error!"); }
    }

    function renderQ() {
        const q = questions[current];
        document.getElementById('q-no').innerText = `Question ${current + 1}`;
        document.getElementById('q-text').innerText = q.text || "";
        const aBox = document.getElementById('q-audio-box');
        if (q.audio) {
            let count = audioLogs[current] || 0;
            aBox.innerHTML = `<button class="audio-btn" onclick="playQuestionAudio('${q.audio}', ${current})" ${count >= 2 ? 'disabled' : ''}>
                üîä ${count >= 2 ? 'LIMIT REACHED' : 'LISTEN (' + count + '/2)'}
            </button>`;
        } else { aBox.innerHTML = ""; }
        const img = document.getElementById('q-img');
        if(q.img) { img.src = q.img; img.style.display = "block"; } else { img.style.display = "none"; }
        const optDiv = document.getElementById('options-container');
        optDiv.innerHTML = "";
        q.options.forEach((opt, i) => {
            let content = opt.toString().match(/\.(jpg|jpeg|png)$/i) ? `<img src="${opt}" style="height:70px; border-radius:5px;">` : 
                          opt.toString().match(/\.mp3$/i) ? `<button class="audio-btn" style="margin:0; width:auto;" onclick="event.stopPropagation(); new Audio('${opt}').play()">üîä Audio</button>` : 
                          `<span>${opt}</span>`;
            optDiv.innerHTML += `<div class="option ${answers[current]===i?'active':''}" onclick="setAns(${i})"><div class="opt-num">${i+1}</div><div>${content}</div></div>`;
        });
        updatePalette();
    }

    function playQuestionAudio(url, id) {
        if (!audioLogs[id]) audioLogs[id] = 0;
        if (audioLogs[id] < 2) { new Audio(url).play(); audioLogs[id]++; renderQ(); }
    }
    function setAns(i) { answers[current] = i; renderQ(); }
    function nextQ() { if(current < questions.length-1) { current++; renderQ(); } }
    function prevQ() { if(current > 0) { current--; renderQ(); } }
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }

    function updatePalette() {
        const rGrid = document.getElementById('reading-grid'), lGrid = document.getElementById('listening-grid');
        rGrid.innerHTML = ""; lGrid.innerHTML = "";
        questions.forEach((_, i) => {
            const btn = document.createElement('div');
            btn.className = `num-btn ${answers[i] !== null ? 'done' : ''} ${i === current ? 'current' : ''}`;
            btn.innerText = i + 1;
            btn.onclick = () => { current = i; renderQ(); if(window.innerWidth < 768) toggleMenu(); };
            if (i < 20) rGrid.appendChild(btn); else lGrid.appendChild(btn);
        });
    }

    function startTimer() {
        const timerObj = setInterval(() => {
            if(timeLeft <= 0) { clearInterval(timerObj); finishPartOne(); }
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
        }, 1000);
    }

    function finishPartOne() {
        document.getElementById('exam-page').classList.remove('active-page');
        document.getElementById('cb-page').classList.add('active-page');
    }

    function nextCB() {
        if(cbCurrent < 5) {
            cbCurrent++;
            document.getElementById('cb-q-no').innerText = `Plate ${cbCurrent} of 5`;
            document.getElementById('cb-display-img').src = `cb${cbCurrent}.jpg`;
            document.getElementById('cb-input').value = "";
        } else { processResults(); }
    }

    async function processResults() {
        let score = 0, reviewHTML = "";
        questions.forEach((q, i) => {
            const isCorrect = answers[i] === q.ans;
            if(isCorrect) score += 2.5;
            reviewHTML += `<div class="review-line">Q${i+1}: <span class="${isCorrect?'correct-ans':'wrong-ans'}">${isCorrect?'‚úì Correct':'‚úó Wrong (Ans: '+(q.ans+1)+')'}</span></div>`;
        });

        document.getElementById('cb-page').classList.remove('active-page');
        document.getElementById('result-page').classList.add('active-page');
        
        const badge = document.getElementById('status-badge');
        document.getElementById('final-score').innerText = `Score: ${score}`;
        document.getElementById('final-stats').innerText = `Correct: ${score/2.5} / ${questions.length}`;
        document.getElementById('review-list').innerHTML = reviewHTML;

        if(score >= 95) {
            badge.innerText = "PASS"; badge.style.color = "var(--success)";
            document.getElementById('download-btn').style.display = "block";
        } else {
            badge.innerText = "FAIL"; badge.style.color = "var(--danger)";
        }

        const data = { name: document.getElementById('user-name').value, sector: document.getElementById('user-job').value, score: score };
        fetch(apiURL, { method: "POST", body: JSON.stringify(data) });
    }

    function generateCertificate() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const name = document.getElementById('user-name').value.toUpperCase();
        const score = document.getElementById('final-score').innerText;
        const job = document.getElementById('user-job').value;

        // Background & Border
        doc.setFillColor(245, 245, 240); doc.rect(0, 0, 297, 210, 'F');
        doc.setDrawColor(212, 175, 55); doc.setLineWidth(5); doc.rect(10, 10, 277, 190);
        doc.setLineWidth(1); doc.rect(13, 13, 271, 184);

        // Header
        doc.setTextColor(20, 30, 60); doc.setFontSize(40); doc.setFont("times", "bold");
        doc.text("CERTIFICATE OF COMPLETION", 148, 50, { align: "center" });

        // Body
        doc.setFontSize(18); doc.setFont("helvetica", "normal");
        doc.text("This is to certify that", 148, 75, { align: "center" });
        
        doc.setFontSize(35); doc.setTextColor(0, 180, 219);
        doc.text(name, 148, 95, { align: "center" });

        doc.setFontSize(18); doc.setTextColor(20, 30, 60);
        doc.text(`has successfully passed the UBT Model Exam for ${job}`, 148, 115, { align: "center" });
        
        doc.setFontSize(22); doc.setFont("times", "bold");
        doc.text(`FINAL SCORE: ${score}`, 148, 135, { align: "center" });

        // Footer
        doc.setFontSize(12); doc.setFont("helvetica", "italic");
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 50, 170);
        doc.text("Authorized by: PPA Exam Center", 240, 170, { align: "right" });

        doc.save(`${name}_Certificate.pdf`);
    }

    async function viewResults() {
        const name = prompt("·Ä°·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´:");
        if(name) {
            const res = await fetch(`${apiURL}?viewResult=true&name=${name}`);
            const data = await res.json();
            if(data.length > 0) alert(`·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äõ·Äô·Äæ·Äê·Ä∫: ${data[data.length-1][3]}`);
            else alert("·Äô·Äê·ÄΩ·Ä±·Ä∑·Äï·Ä´·Åã");
        }
    }
</script>
</body>
    </html>
