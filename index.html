<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UBT & Color Blind Test System</title>
    <style>
        :root { --primary: #00b4db; --dark: #12192c; --white: #ffffff; }
        body { font-family: sans-serif; margin: 0; background: var(--dark); color: #333; }
        
        /* Pages Control */
        .page { display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active-page { display: flex; }

        /* Login & Card Style */
        .card { width: 100%; max-width: 400px; background: #161b22; border-radius: 15px; border: 1px solid #30363d; color: white; padding-bottom: 20px; overflow: hidden; }
        .header { background: linear-gradient(90deg, #00d2ff, #3a7bd5); padding: 15px; text-align: center; font-weight: bold; }
        input, select { width: 85%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: white; }
        .btn { width: 85%; padding: 15px; border: none; background: linear-gradient(90deg, #00f260, #0575e6); color: white; font-weight: bold; border-radius: 8px; cursor: pointer; }

        /* Exam UI */
        #exam-page { background: #f0f2f5; justify-content: flex-start; }
        .top-bar { width: 100%; background: #1a233a; color: white; padding: 10px; display: flex; justify-content: space-between; position: sticky; top: 0; }
        .q-card { width: 100%; max-width: 500px; background: white; padding: 20px; border-radius: 10px; margin-top: 20px; border-top: 5px solid var(--primary); }
        .audio-btn { background: #ffc107; border: none; padding: 10px 20px; border-radius: 20px; margin: 10px 0; cursor: pointer; font-weight: bold; }
        .option { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin: 10px 0; display: flex; align-items: center; cursor: pointer; width: 100%; max-width: 500px; }
        .option.active { border: 2px solid var(--primary); background: #e1f5fe; }
        .opt-num { width: 25px; height: 25px; border: 1px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 15px; }

        /* Color Blind UI */
        .cb-img { width: 250px; height: 250px; border-radius: 50%; border: 5px solid white; margin: 20px 0; }
    </style>
</head>
<body>

<div id="login-page" class="page active-page">
    <div class="card">
        <div class="header">UBT EXAM LOGIN</div>
        <center>
            <input type="text" id="user-name" placeholder="Full Name">
            <select id="user-job">
                <option>Manufacturing (Ï†úÏ°∞ÏóÖ)</option>
                <option>Agriculture (ÎÜçÏóÖ)</option>
                <option>Construction (Í±¥ÏÑ§ÏóÖ)</option>
            </select>
            <button class="btn" onclick="startExam()">START EXAM</button>
            <p style="font-size: 12px; color: #58a6ff; cursor: pointer;" onclick="viewResults()">VIEW OLD RESULTS</p>
        </center>
    </div>
</div>

<div id="exam-page" class="page">
    <div class="top-bar">
        <div id="display-name">Name</div>
        <div id="timer" style="background:#ff0055; padding:2px 10px; border-radius:5px;">20:00</div>
    </div>
    <div class="q-card">
        <div id="q-no" style="color:var(--primary); font-weight:bold;">Question 1</div>
        <div id="q-text" style="font-size: 18px; margin: 10px 0;"></div>
        <div id="q-audio-box"></div>
        <img id="q-img" src="" style="width:100%; display:none; border-radius:8px;">
    </div>
    <div id="options-container" style="width:100%; max-width:500px;"></div>
    <div style="display:flex; gap:10px; margin-top:20px; width:100%; max-width:500px;">
        <button class="btn" style="background:#2c3e50;" onclick="prevQ()">PREV</button>
        <button class="btn" style="background:#2c3e50;" onclick="nextQ()">NEXT</button>
    </div>
    <button class="btn" style="background:#ff0055; margin-top:10px;" onclick="goToColorBlind()">FINISH PART 1</button>
</div>

<div id="cb-page" class="page">
    <div class="card" style="text-align: center;">
        <div class="header">COLOR BLIND TEST</div>
        <div id="cb-q-no" style="margin-top:10px;">Plate 1 of 5</div>
        <img id="cb-display-img" class="cb-img" src="cb1.jpg">
        <input type="number" id="cb-input" placeholder="·Äï·ÄØ·Ä∂·Äë·Ä≤·ÄÄ·ÄÇ·Äè·Äî·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´">
        <button class="btn" onclick="nextCB()">NEXT PLATE</button>
    </div>
</div>

<script>
    const apiURL = "https://script.google.com/macros/s/AKfycbycLVJ64q_BiSIVvsugR4pFn0tk8tkaS-agzwICHSbMOK0dNtw5-ZgLe-H5lMaU9Gax8w/exec"; // <--- ·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ URL ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´
    let questions = [];
    let current = 0;
    let answers = [];
    let timeLeft = 20 * 60;
    let cbCurrent = 1;

    async function startExam() {
        const name = document.getElementById('user-name').value;
        if(!name) return alert("·Äî·Ä¨·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´");
        
        document.getElementById('login-page').classList.remove('active-page');
        document.getElementById('exam-page').classList.add('active-page');
        document.getElementById('display-name').innerText = name;

        try {
            const res = await fetch(apiURL);
            questions = await res.json();
            answers = new Array(questions.length).fill(null);
            renderQ();
            startTimer();
        } catch(e) { alert("Data Error!"); }
    }

    function renderQ() {
        const q = questions[current];
        document.getElementById('q-no').innerText = `Question ${current + 1}`;
        document.getElementById('q-text').innerText = q.text || "";
        
        const aBox = document.getElementById('q-audio-box');
        aBox.innerHTML = q.audio ? `<button class="audio-btn" onclick="play('${q.audio}')">üîä Listen Question</button>` : "";

        const img = document.getElementById('q-img');
        if(q.img) { img.src = q.img; img.style.display = "block"; } else { img.style.display = "none"; }

        const optDiv = document.getElementById('options-container');
        optDiv.innerHTML = "";
        q.options.forEach((opt, i) => {
            let content = "";
            if(opt.toString().match(/\.(jpg|jpeg|png)$/i)) content = `<img src="${opt}" style="height:70px;">`;
            else if(opt.toString().match(/\.mp3$/i)) content = `<button class="audio-btn" onclick="event.stopPropagation(); play('${opt}')">üîä Audio</button>`;
            else content = `<span>${opt}</span>`;

            optDiv.innerHTML += `
                <div class="option ${answers[current]===i?'active':''}" onclick="setAns(${i})">
                    <div class="opt-num">${i+1}</div>
                    <div>${content}</div>
                </div>`;
        });
    }

    function setAns(i) { answers[current] = i; renderQ(); }
    function nextQ() { if(current < questions.length-1) { current++; renderQ(); } }
    function prevQ() { if(current > 0) { current--; renderQ(); } }
    function play(file) { new Audio(file).play(); }

    function startTimer() {
        const timerObj = setInterval(() => {
            if(timeLeft <= 0) { clearInterval(timerObj); goToColorBlind(); }
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
        }, 1000);
    }

    function goToColorBlind() {
        document.getElementById('exam-page').classList.remove('active-page');
        document.getElementById('cb-page').classList.add('active-page');
    }

    function nextCB() {
        if(cbCurrent < 5) {
            cbCurrent++;
            document.getElementById('cb-q-no').innerText = `Plate ${cbCurrent} of 5`;
            document.getElementById('cb-display-img').src = `cb${cbCurrent}.jpg`;
            document.getElementById('cb-input').value = "";
        } else {
            submitResults();
        }
    }

    async function submitResults() {
        let score = 0;
        questions.forEach((q, i) => { if(answers[i] === q.ans) score += 5; });
        
        const data = {
            name: document.getElementById('user-name').value,
            sector: document.getElementById('user-job').value,
            score: score
        };

        await fetch(apiURL, { method: "POST", body: JSON.stringify(data) });
        alert("·ÄÖ·Ä¨·Äô·Ä±·Ä∏·Äï·ÄΩ·Ä≤·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·ÄÖ·ÄΩ·Ä¨ ·Äñ·Äº·Ä±·ÄÜ·Ä≠·ÄØ·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã");
        location.reload();
    }

    async function viewResults() {
        const name = prompt("·Äõ·Äú·Äí·Ä∫·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫ ·Äî·Ä¨·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´:");
        if(name) {
            const res = await fetch(`${apiURL}?viewResult=true&name=${name}`);
            const data = await res.json();
            if(data.length > 0) alert(`${name} ·Åè ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äõ·Äô·Äæ·Äê·Ä∫·Äô·Äæ·Ä¨ ${data[data.length-1][3]} ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã Status: ${data[data.length-1][4]}`);
            else alert("·Äí·Ä±·Äê·Ä¨·Äô·Äõ·Äæ·Ä≠·Äï·Ä´·Åã");
        }
    }
</script>
</body>
</html>
